generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String?
  displayName      String?
  bio              String?
  avatarUrl        String?
  password         String
  refreshToken     String?        @db.Text
  isApproved       Boolean        @default(true)
  inventoryHash    String?
  lastLoginAt      DateTime?
  lastInventorySync DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?
  
  // Relations
  userPlugins      UserPlugin[]
  presence         UserPresence[]
  activityLogs     ActivityLog[]
  crashReports     CrashReport[]
  webRtcMetrics    WebRtcMetric[]
  devices          Device[]
}

model Plugin {
  id          String       @id @default(cuid())
  name        String
  description String?
  version     String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  
  // Relations
  userPlugins UserPlugin[]
}

model Device {
  id           String   @id @default(cuid())
  userId       String
  name         String
  type         String   // e.g., 'DAW_PLUGIN', 'MOBILE', 'WEB'
  info         Json?    // Additional device-specific info
  lastActiveAt DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserPlugin {
  id        String   @id @default(cuid())
  userId    String
  pluginId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user      User     @relation(fields: [userId], references: [id])
  plugin    Plugin   @relation(fields: [pluginId], references: [id])
  
  @@unique([userId, pluginId])
}

model UserPresence {
  id         String   @id @default(cuid())
  userId     String
  projectId  String?
  status     String
  expiresAt  DateTime
  lastSeen   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  user       User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, projectId])
  @@index([expiresAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entityType  String
  entityId    String
  projectId   String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])
  
  @@index([userId])
  @@index([projectId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model CrashReport {
  id          String   @id @default(cuid())
  userId      String
  error       String
  stackTrace  String
  stack       String?
  breadcrumbs String?
  context     String?
  projectId   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
}

model WebRtcMetric {
  id                  String   @id @default(cuid())
  userId              String
  projectId           String?
  metricType          String
  value               Float
  peerConnectionId    String?
  rttMs               Float?
  jitterMs            Float?
  packetLoss          Float?
  networkType         String?
  effectiveType       String?
  downlinkMbps        Float?
  iceCandidatePairId  String?
  localCandidateId    String?
  remoteCandidateId   String?
  timestamp           DateTime
  metadata            Json?
  createdAt           DateTime @default(now())
  
  // Relations
  user                User     @relation(fields: [userId], references: [id])
  
  @@index([userId, projectId, timestamp])
}

model Project {
  id          String     @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  
  // Relations
  snapshots   Snapshot[]
  activityLogs ActivityLog[]
}

model Snapshot {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  description String?
  data        Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  project     Project    @relation(fields: [projectId], references: [id])
  tags        EntityTag[] @relation("SnapshotTags")
}

model Tag {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  color       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  entityTags  EntityTag[]
}

model EntityTag {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  tagId       String
  snapshotId  String?
  createdAt   DateTime @default(now())
  
  // Relations
  tag         Tag      @relation(fields: [tagId], references: [id])
  snapshot    Snapshot? @relation("SnapshotTags", fields: [snapshotId], references: [id])
  
  @@unique([entityType, entityId, tagId])
}
