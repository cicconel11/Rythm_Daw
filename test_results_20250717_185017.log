
> rhythm-server@0.1.0 test /Users/louisciccone/Desktop/Rythm_Daw/server
> cross-env NODE_ENV=test jest --config=jest.config.js

FAIL test/ws-heartbeat-e2e.test.ts (15.687 s)
  ● ChatGateway (e2e) › should establish WebSocket connection and handle ping/pong

    TypeError: server.on is not a function

      74 |     io = new Server(httpServer);
      75 |     
    > 76 |     await app.init();
         |     ^
      77 |   });
      78 |
      79 |   afterAll(async () => {

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Object.<anonymous> (test/ws-heartbeat-e2e.test.ts:76:5)

  ● ChatGateway (e2e) › should disconnect client after missing pongs

    TypeError: server.on is not a function

      74 |     io = new Server(httpServer);
      75 |     
    > 76 |     await app.init();
         |     ^
      77 |   });
      78 |
      79 |   afterAll(async () => {

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Object.<anonymous> (test/ws-heartbeat-e2e.test.ts:76:5)


  ● Test suite failed to run

    thrown: "Exceeded timeout of 15000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      77 |   });
      78 |
    > 79 |   afterAll(async () => {
         |   ^
      80 |     await app.close();
      81 |     httpServer.close();
      82 |   });

      at test/ws-heartbeat-e2e.test.ts:79:3
      at Object.<anonymous> (test/ws-heartbeat-e2e.test.ts:14:1)

FAIL test/websocket.simple.spec.ts (15.324 s)
  ● WebSocket (Simple) › should be defined

    TypeError: server.on is not a function

      47 |     
      48 |     // Initialize app
    > 49 |     await app.init();
         |     ^
      50 |     
      51 |     // Start HTTP server
      52 |     await new Promise<void>((resolve) => {

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Object.<anonymous> (test/websocket.simple.spec.ts:49:5)

  ● WebSocket (Simple) › should connect to the WebSocket server

    TypeError: server.on is not a function

      47 |     
      48 |     // Initialize app
    > 49 |     await app.init();
         |     ^
      50 |     
      51 |     // Start HTTP server
      52 |     await new Promise<void>((resolve) => {

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Object.<anonymous> (test/websocket.simple.spec.ts:49:5)

  ● WebSocket (Simple) › should handle disconnection

    TypeError: server.on is not a function

      47 |     
      48 |     // Initialize app
    > 49 |     await app.init();
         |     ^
      50 |     
      51 |     // Start HTTP server
      52 |     await new Promise<void>((resolve) => {

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Object.<anonymous> (test/websocket.simple.spec.ts:49:5)


  ● Test suite failed to run

    thrown: "Exceeded timeout of 15000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      59 |   }, 10000);
      60 |
    > 61 |   afterAll(async () => {
         |   ^
      62 |     await app.close();
      63 |     httpServer.close();
      64 |   });

      at test/websocket.simple.spec.ts:61:3
      at Object.<anonymous> (test/websocket.simple.spec.ts:28:1)

[32m[Nest] 66292  - [39m07/17/2025, 6:50:49 PM [32m    LOG[39m [38;5;3m[NestApplication] [39m[32mNest application successfully started[39m
FAIL test/websocket.heartbeat.spec.ts (15.201 s)
  ● WebSocket Heartbeat › should connect to the WebSocket server

    TypeError: Cannot read properties of undefined (reading 'on')

      107 |     const client = mockIo('http://localhost:3000');
      108 |     
    > 109 |     client.on('connect', () => {
          |            ^
      110 |       expect(client.connected).toBe(true);
      111 |       client.disconnect();
      112 |       done();

      at Object.<anonymous> (test/websocket.heartbeat.spec.ts:109:12)

  ● WebSocket Heartbeat › should handle ping-pong

    TypeError: Cannot read properties of undefined (reading 'emit')

      120 |     const client = mockIo('http://localhost:3000');
      121 |     
    > 122 |     client.emit('ping', { timestamp: 12345 }, (response: any) => {
          |            ^
      123 |       expect(response).toHaveProperty('timestamp');
      124 |       expect(response.timestamp).toBe(12345);
      125 |       client.disconnect();

      at Object.<anonymous> (test/websocket.heartbeat.spec.ts:122:12)

  ● WebSocket Heartbeat › should handle disconnection

    TypeError: Cannot read properties of undefined (reading 'on')

      131 |     const client = mockIo('http://localhost:3000');
      132 |     
    > 133 |     client.on('disconnect', () => {
          |            ^
      134 |       expect(client.connected).toBe(false);
      135 |       done();
      136 |     });

      at Object.<anonymous> (test/websocket.heartbeat.spec.ts:133:12)

  ● WebSocket Heartbeat › should trigger gateway connection handlers

    TypeError: Cannot read properties of undefined (reading 'emit')

      146 |     
      147 |     // Simulate connection
    > 148 |     client.emit('connection');
          |            ^
      149 |     
      150 |     process.nextTick(() => {
      151 |       expect(handleConnectionSpy).toHaveBeenCalledTimes(1);

      at Object.<anonymous> (test/websocket.heartbeat.spec.ts:148:12)


  ● Test suite failed to run

    thrown: "Exceeded timeout of 15000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

       95 |   }, 10000);
       96 |
    >  97 |   afterAll(async () => {
          |   ^
       98 |     await app.close();
       99 |     jest.clearAllMocks();
      100 |   });

      at test/websocket.heartbeat.spec.ts:97:3
      at Object.<anonymous> (test/websocket.heartbeat.spec.ts:76:1)

FAIL test/websocket.spec.ts (15.144 s)
  ● Console

    console.log
      Test WebSocket server running on ws://localhost:65224

      at Server.<anonymous> (test/websocket.spec.ts:52:15)

    console.error
      Error handling message: SyntaxError: "[object Object]" is not valid JSON
          at JSON.parse (<anonymous>)
          at WebSocket.<anonymous> (/Users/louisciccone/Desktop/Rythm_Daw/server/test/websocket.spec.ts:299:37)
          at WebSocket.emit (node:events:507:28)
          at Receiver.receiverOnMessage (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1068:20)
          at Receiver.emit (node:events:507:28)
          at Receiver.dataMessage (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:517:14)
          at Receiver.getData (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:435:17)
          at Receiver.startLoop (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:143:22)
          at Receiver._write (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:78:10)
          at writeOrBuffer (node:internal/streams/writable:570:12)
          at _write (node:internal/streams/writable:499:10)
          at Receiver.Writable.write (node:internal/streams/writable:508:10)
          at Socket.socketOnData (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1162:35)
          at Socket.emit (node:events:507:28)
          at addChunk (node:internal/streams/readable:559:12)
          at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
          at Socket.Readable.push (node:internal/streams/readable:390:5)
          at TCP.onStreamRead (node:internal/stream_base_commons:189:23)

      304 |         }
      305 |       } catch (err) {
    > 306 |         console.error('Error handling message:', err);
          |                 ^
      307 |       }
      308 |     });
      309 |     

      at WebSocket.<anonymous> (test/websocket.spec.ts:306:17)
      at Receiver.receiverOnMessage (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1068:20)
      at Receiver.dataMessage (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:517:14)
      at Receiver.getData (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:435:17)
      at Receiver.startLoop (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:143:22)
      at Receiver._write (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:78:10)
      at Socket.socketOnData (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1162:35)

    console.error
      Error handling message: SyntaxError: "[object Object]" is not valid JSON
          at JSON.parse (<anonymous>)
          at WebSocket.<anonymous> (/Users/louisciccone/Desktop/Rythm_Daw/server/test/websocket.spec.ts:284:37)
          at WebSocket.emit (node:events:507:28)
          at Receiver.receiverOnMessage (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1068:20)
          at Receiver.emit (node:events:507:28)
          at Receiver.dataMessage (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:517:14)
          at Receiver.getData (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:435:17)
          at Receiver.startLoop (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:143:22)
          at Receiver._write (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:78:10)
          at writeOrBuffer (node:internal/streams/writable:570:12)
          at _write (node:internal/streams/writable:499:10)
          at Receiver.Writable.write (node:internal/streams/writable:508:10)
          at Socket.socketOnData (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1162:35)
          at Socket.emit (node:events:507:28)
          at addChunk (node:internal/streams/readable:559:12)
          at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
          at Socket.Readable.push (node:internal/streams/readable:390:5)
          at TCP.onStreamRead (node:internal/stream_base_commons:189:23)

      289 |         }
      290 |       } catch (err) {
    > 291 |         console.error('Error handling message:', err);
          |                 ^
      292 |       }
      293 |     });
      294 |     

      at WebSocket.<anonymous> (test/websocket.spec.ts:291:17)
      at Receiver.receiverOnMessage (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1068:20)
      at Receiver.dataMessage (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:517:14)
      at Receiver.getData (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:435:17)
      at Receiver.startLoop (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:143:22)
      at Receiver._write (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:78:10)
      at Socket.socketOnData (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1162:35)

    console.log
      Test teardown complete

      at Server.<anonymous> (test/websocket.spec.ts:173:21)

  ● WebSocket Server › should send and receive messages

    SyntaxError: "[object Object]" is not valid JSON
        at JSON.parse (<anonymous>)

      224 |         const message = JSON.parse(data.toString());
      225 |         if (message.type === 'echo') {
    > 226 |           expect(JSON.parse(message.data)).toEqual(JSON.parse(testMessage));
          |                       ^
      227 |           client.close();
      228 |           done();
      229 |         }

      at WebSocket.<anonymous> (test/websocket.spec.ts:226:23)
      at Receiver.receiverOnMessage (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1068:20)
      at Receiver.dataMessage (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:517:14)
      at Receiver.getData (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:435:17)
      at Receiver.startLoop (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:143:22)
      at Receiver._write (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/receiver.js:78:10)
      at Socket.socketOnData (../node_modules/.pnpm/ws@7.5.9/node_modules/ws/lib/websocket.js:1162:35)

  ● WebSocket Server › should handle multiple clients

    thrown: "Exceeded timeout of 15000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      241 |   });
      242 |   
    > 243 |   test('should handle multiple clients', (done) => {
          |   ^
      244 |     // Increase timeout for this test
      245 |     jest.setTimeout(15000);
      246 |     const client1 = new WebSocket(serverUrl);

      at test/websocket.spec.ts:243:3
      at Object.<anonymous> (test/websocket.spec.ts:32:1)

FAIL test/ws-connection.spec.ts (15.521 s)
  ● Console

    console.warn
      Running with mock S3 client - file operations will not persist

      40 |       }
      41 |     } else {
    > 42 |       console.warn('Running with mock S3 client - file operations will not persist');
         |               ^
      43 |     }
      44 |
      45 |     this.s3 = new AWS.S3();

      at new AwsS3Service (src/modules/files/aws-s3.service.ts:42:15)
      at TestingInjector.instantiateClass (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:373:19)
      at callback (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:65:45)
      at TestingInjector.resolveConstructorParams (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:145:24)
      at TestingInjector.loadInstance (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 4)
      at TestingInstanceLoader.createInstancesOfProviders (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 11)
      at TestingInstanceLoader.createInstances (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../node_modules/.pnpm/@nestjs+testing@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0._bde94f0843f7709eed75faa2d8eec233/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../node_modules/.pnpm/@nestjs+testing@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0._bde94f0843f7709eed75faa2d8eec233/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../node_modules/.pnpm/@nestjs+testing@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0._bde94f0843f7709eed75faa2d8eec233/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at Object.<anonymous> (test/ws-connection.spec.ts:13:27)

  ● WebSocket Connection › should connect and receive a ping

    TypeError: server.on is not a function

      19 |     
      20 |     // Initialize the app first
    > 21 |     await app.init();
         |     ^
      22 |     
      23 |     // Start HTTP server on a random port
      24 |     const server = await app.listen(0);

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Object.<anonymous> (test/ws-connection.spec.ts:21:5)


  ● Test suite failed to run

    thrown: "Exceeded timeout of 15000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      28 |   }, 30000); // 30s timeout for setup
      29 |
    > 30 |   afterAll(async () => {
         |   ^
      31 |     if (app) {
      32 |       await app.close();
      33 |       // Give the server a moment to close

      at test/ws-connection.spec.ts:30:3
      at Object.<anonymous> (test/ws-connection.spec.ts:7:1)

FAIL test/ws-simple.spec.ts
  ● Console

    console.warn
      Running with mock S3 client - file operations will not persist

      40 |       }
      41 |     } else {
    > 42 |       console.warn('Running with mock S3 client - file operations will not persist');
         |               ^
      43 |     }
      44 |
      45 |     this.s3 = new AWS.S3();

      at new AwsS3Service (src/modules/files/aws-s3.service.ts:42:15)
      at TestingInjector.instantiateClass (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:373:19)
      at callback (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:65:45)
      at TestingInjector.resolveConstructorParams (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:145:24)
      at TestingInjector.loadInstance (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 4)
      at TestingInstanceLoader.createInstancesOfProviders (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 11)
      at TestingInstanceLoader.createInstances (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../node_modules/.pnpm/@nestjs+testing@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0._bde94f0843f7709eed75faa2d8eec233/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../node_modules/.pnpm/@nestjs+testing@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0._bde94f0843f7709eed75faa2d8eec233/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../node_modules/.pnpm/@nestjs+testing@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0._bde94f0843f7709eed75faa2d8eec233/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at createTestApp (test/ws-simple.spec.ts:9:25)
      at Object.<anonymous> (test/ws-simple.spec.ts:49:21)

  ● WebSocket (Simple Test) › should connect and echo a message

    TypeError: server.on is not a function

      14 |   
      15 |   // Use Socket.IO with HTTP server
    > 16 |   const httpServer = await app.listen(0);
         |                      ^
      17 |   const io = new Server(httpServer, {
      18 |     cors: {
      19 |       origin: '*',

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Proxy.listen (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:172:13)
      at createTestApp (test/ws-simple.spec.ts:16:22)
      at Object.<anonymous> (test/ws-simple.spec.ts:49:21)

  ● WebSocket (Simple Test) › should handle disconnection

    TypeError: server.on is not a function

      14 |   
      15 |   // Use Socket.IO with HTTP server
    > 16 |   const httpServer = await app.listen(0);
         |                      ^
      17 |   const io = new Server(httpServer, {
      18 |     cors: {
      19 |       origin: '*',

      at IoAdapter.bindClientConnect (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/adapters/ws-adapter.js:23:16)
      at WebSocketsController.subscribeEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:54:17)
      at WebSocketsController.subscribeToServerEvents (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:45:14)
      at WebSocketsController.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/web-sockets-controller.js:30:14)
      at SocketModule.connectGatewayToServer (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:47:35)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:38
      at IteratorWithOperators.forEach (../node_modules/.pnpm/iterare@1.2.1/node_modules/iterare/src/iterate.ts:202:13)
      at SocketModule.connectAllGateways (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:36:14)
      at ../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:61
          at ModulesContainer.forEach (<anonymous>)
      at SocketModule.register (../node_modules/.pnpm/@nestjs+websockets@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator_aa0769972f09784d8464dd424c71bca3/node_modules/@nestjs/websockets/socket-module.js:31:17)
      at Proxy.registerWsModule (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:88:27)
      at Proxy.registerModules (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:77:14)
      at Proxy.init (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:98:20)
      at Proxy.listen (../node_modules/.pnpm/@nestjs+core@11.1.3_@nestjs+common@11.1.3_class-transformer@0.5.1_class-validator@0.14._c362ab2a5d80cd719c88bbc8d32eee7a/node_modules/@nestjs/core/nest-application.js:172:13)
      at createTestApp (test/ws-simple.spec.ts:16:22)
      at Object.<anonymous> (test/ws-simple.spec.ts:49:21)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'close')

      55 |   
      56 |   afterAll(async () => {
    > 57 |     await app.close();
         |               ^
      58 |   });
      59 |   
      60 |   it('should connect and echo a message', (done) => {

      at Object.<anonymous> (test/ws-simple.spec.ts:57:15)

FAIL test/websocket.e2e.spec.ts
  ● WebSocket (e2e) › should connect to WebSocket server

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket.e2e.spec.ts:12:32)

  ● WebSocket (e2e) › should receive echo message

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket.e2e.spec.ts:12:32)

  ● WebSocket (e2e) › should handle multiple messages

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket.e2e.spec.ts:12:32)

  ● WebSocket (e2e) › should handle disconnection

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket.e2e.spec.ts:12:32)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'app')

      27 |       client.disconnect();
      28 |     }
    > 29 |     await teardownTestApp(ctx.app, ctx.httpServer);
         |                               ^
      30 |   });
      31 |
      32 |   afterEach(() => {

      at Object.<anonymous> (test/websocket.e2e.spec.ts:29:31)

FAIL test/standalone-ws.test.ts
  ● Console

    console.log
      [Test Server] Test WebSocket server running on port 49270

      at Socket.<anonymous> (test/standalone-ws.test.ts:44:17)

    console.log
      WebSocket server started on port 49270

      at ChildProcess.<anonymous> (test/standalone-ws.test.ts:32:19)

    console.log
      [Test Server] Shutting down test WebSocket server

      at Socket.<anonymous> (test/standalone-ws.test.ts:44:17)

    console.log
      [Test Server] Test WebSocket server stopped

      at Socket.<anonymous> (test/standalone-ws.test.ts:44:17)

  ● Standalone WebSocket Server › should connect to the WebSocket server

    TypeError: Cannot read properties of undefined (reading 'on')

      155 |     };
      156 |
    > 157 |     socket.on('connect', onConnect);
          |            ^
      158 |     socket.on('connect_error', onError);
      159 |
      160 |     // Set a timeout in case the socket doesn't connect

      at Object.<anonymous> (test/standalone-ws.test.ts:157:12)

  ● Standalone WebSocket Server › should echo messages

    TypeError: Cannot read properties of undefined (reading 'on')

      217 |     };
      218 |
    > 219 |     socket.on('connect', onConnect);
          |            ^
      220 |     socket.on('connect_error', onError);
      221 |
      222 |     // Set a timeout for the test

      at Object.<anonymous> (test/standalone-ws.test.ts:219:12)

  ● Standalone WebSocket Server › should handle disconnection

    TypeError: Cannot read properties of undefined (reading 'on')

      273 |     };
      274 |
    > 275 |     socket.on('connect', onConnect);
          |            ^
      276 |     socket.on('connect_error', onError);
      277 |
      278 |     // Set a timeout for the test

      at Object.<anonymous> (test/standalone-ws.test.ts:275:12)

FAIL test/rtc.gateway.spec.ts
  ● RtcGateway › emitToUser › should emit event to user

    TypeError: this.server.to is not a function

      627 |       const sockets = this.userSockets.get(userId);
      628 |       if (!sockets || sockets.size === 0) return false;
    > 629 |       sockets.forEach(sid => this.server.to(sid).emit(event, payload));
          |                                          ^
      630 |       return true;
      631 |     }
      632 |

      at src/modules/rtc/rtc.gateway.ts:629:42
          at Set.forEach (<anonymous>)
      at TestRtcGateway.emitToUser (src/modules/rtc/rtc.gateway.ts:629:15)
      at Object.<anonymous> (test/rtc.gateway.spec.ts:429:30)

FAIL test/ws-server.test.ts
  ● WebSocket Server › should connect and disconnect

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/ws-server.test.ts:12:42)

  ● WebSocket Server › should connect and disconnect

    TypeError: Cannot read properties of undefined (reading 'connected')

      52 |
      53 |   afterEach((done) => {
    > 54 |     if (clientSocket.connected) {
         |                      ^
      55 |       clientSocket.disconnect();
      56 |     }
      57 |     done();

      at Object.<anonymous> (test/ws-server.test.ts:54:22)

  ● WebSocket Server › should send and receive messages

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/ws-server.test.ts:12:42)

  ● WebSocket Server › should send and receive messages

    TypeError: Cannot read properties of undefined (reading 'connected')

      52 |
      53 |   afterEach((done) => {
    > 54 |     if (clientSocket.connected) {
         |                      ^
      55 |       clientSocket.disconnect();
      56 |     }
      57 |     done();

      at Object.<anonymous> (test/ws-server.test.ts:54:22)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'close')

      30 |
      31 |   afterAll(async () => {
    > 32 |     await app.close();
         |               ^
      33 |   });
      34 |
      35 |   beforeEach((done) => {

      at Object.<anonymous> (test/ws-server.test.ts:32:15)

FAIL test/websocket/chat.gateway.spec.ts
  ● ChatGateway › handleConnection › should accept connection with valid token

    expect(received).toBe(expected) // Object.is equality

    Expected: "user-123"
    Received: undefined

      122 |       await (gateway as any).handleConnection(mockClient, mockRequest);
      123 |       
    > 124 |       expect(mockClient.userId).toBe('user-123');
          |                                 ^
      125 |       expect(mockPresenceService.updateUserPresence).toHaveBeenCalledWith(
      126 |         'user-123',
      127 |         true

      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:124:33)

  ● ChatGateway › handleConnection › should reject connection with invalid token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Authentication failed for client test-client-2: Invalid token"

    Number of calls: 0

      146 |       
      147 |       expect(mockClient.terminate).toHaveBeenCalled();
    > 148 |       expect(mockLogger.error).toHaveBeenCalledWith(
          |                                ^
      149 |         'Authentication failed for client test-client-2: Invalid token'
      150 |       );
      151 |     });

      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:148:32)

  ● ChatGateway › handleDisconnect › should clean up resources when client disconnects

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Client disconnected: test-client-3 (user-123)"

    Number of calls: 0

      165 |       expect(mockPresenceService.removeUserPresence).toHaveBeenCalledWith('user-123');
      166 |       expect((gateway as any).clients.has(mockClient)).toBe(false);
    > 167 |       expect(mockLogger.log).toHaveBeenCalledWith(
          |                              ^
      168 |         'Client disconnected: test-client-3 (user-123)'
      169 |       );
      170 |     });

      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:167:30)

  ● ChatGateway › handleMessage › should process valid message

    Property `broadcastToRoom` does not exist in the provided object

      184 |       
      185 |       // Mock the broadcast method
    > 186 |       const broadcastSpy = jest.spyOn(gateway as any, 'broadcastToRoom');
          |                                 ^
      187 |       
      188 |       // Simulate message
      189 |       await (gateway as any).handleMessage(mockClient, JSON.stringify(testMessage));

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:731:13)
      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:186:33)

  ● ChatGateway › handleMessage › should handle invalid message format

    TypeError: client.sendMessage is not a function

      203 |     } catch (error) {
      204 |       this.logger.error(`Message handling error: ${error.message}`, error.stack);
    > 205 |       await client.sendMessage({
          |                    ^
      206 |         type: 'error',
      207 |         code: 'MESSAGE_ERROR',
      208 |         message: error.message,

      at ChatGateway.handleMessage (src/modules/websocket/chat.gateway.ts:205:20)
      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:207:30)

  ● ChatGateway › handleMessage › should handle invalid JSON message

    TypeError: client.sendMessage is not a function

      203 |     } catch (error) {
      204 |       this.logger.error(`Message handling error: ${error.message}`, error.stack);
    > 205 |       await client.sendMessage({
          |                    ^
      206 |         type: 'error',
      207 |         code: 'MESSAGE_ERROR',
      208 |         message: error.message,

      at ChatGateway.handleMessage (src/modules/websocket/chat.gateway.ts:205:20)
      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:219:30)

  ● ChatGateway › heartbeat › should terminate inactive connections

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      245 |       
      246 |       expect(activeClient.terminate).not.toHaveBeenCalled();
    > 247 |       expect(inactiveClient.terminate).toHaveBeenCalled();
          |                                        ^
      248 |       
      249 |       // Clean up
      250 |       jest.useRealTimers();

      at Object.<anonymous> (test/websocket/chat.gateway.spec.ts:247:40)

FAIL test/websocket/websocket.gateway.spec.ts
  ● WebSocket Gateway (e2e) › Connection › should connect to WebSocket server

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket/websocket.gateway.spec.ts:13:36)

  ● WebSocket Gateway (e2e) › Connection › should reject connection without authentication

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket/websocket.gateway.spec.ts:13:36)

  ● WebSocket Gateway (e2e) › Messaging › should send and receive messages

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket/websocket.gateway.spec.ts:13:36)

  ● WebSocket Gateway (e2e) › Presence › should track user presence

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket/websocket.gateway.spec.ts:13:36)

  ● WebSocket Gateway (e2e) › Disconnection › should handle client disconnection

    TypeError: express is not a function

      20 |  */
      21 | export async function createWsTestApp(): Promise<WsTestContext> {
    > 22 |   const expressApp = express();
         |                      ^
      23 |   const httpServer = createServer(expressApp);
      24 |
      25 |   // Create testing module with required dependencies

      at createWsTestApp (test/websocket-test.setup.ts:22:22)
      at Object.<anonymous> (test/websocket/websocket.gateway.spec.ts:13:36)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'app')

      19 |     
      20 |     // Clean up the test application
    > 21 |     await teardownTestApp(context.app, context.httpServer);
         |                                   ^
      22 |   });
      23 |
      24 |   afterEach(async () => {

      at Object.<anonymous> (test/websocket/websocket.gateway.spec.ts:21:35)

FAIL test/websocket.smoke.spec.ts
  ● WebSocket Smoke Test › should establish WebSocket connection

    TypeError: (0 , websocket_test_setup_1.setupTestApp) is not a function

      25 |   beforeAll(async () => {
      26 |     // Setup test application
    > 27 |     const testApp = await setupTestApp();
         |                                       ^
      28 |     app = testApp.app;
      29 |     port = app.getHttpServer().address().port;
      30 |     

      at Object.<anonymous> (test/websocket.smoke.spec.ts:27:39)

  ● WebSocket Smoke Test › should reject connection with invalid token

    TypeError: (0 , websocket_test_setup_1.setupTestApp) is not a function

      25 |   beforeAll(async () => {
      26 |     // Setup test application
    > 27 |     const testApp = await setupTestApp();
         |                                       ^
      28 |     app = testApp.app;
      29 |     port = app.getHttpServer().address().port;
      30 |     

      at Object.<anonymous> (test/websocket.smoke.spec.ts:27:39)

  ● WebSocket Smoke Test › should send and receive messages

    TypeError: (0 , websocket_test_setup_1.setupTestApp) is not a function

      25 |   beforeAll(async () => {
      26 |     // Setup test application
    > 27 |     const testApp = await setupTestApp();
         |                                       ^
      28 |     app = testApp.app;
      29 |     port = app.getHttpServer().address().port;
      30 |     

      at Object.<anonymous> (test/websocket.smoke.spec.ts:27:39)

  ● WebSocket Smoke Test › should maintain connection with ping/pong

    TypeError: (0 , websocket_test_setup_1.setupTestApp) is not a function

      25 |   beforeAll(async () => {
      26 |     // Setup test application
    > 27 |     const testApp = await setupTestApp();
         |                                       ^
      28 |     app = testApp.app;
      29 |     port = app.getHttpServer().address().port;
      30 |     

      at Object.<anonymous> (test/websocket.smoke.spec.ts:27:39)

  ● WebSocket Smoke Test › should handle disconnection

    TypeError: (0 , websocket_test_setup_1.setupTestApp) is not a function

      25 |   beforeAll(async () => {
      26 |     // Setup test application
    > 27 |     const testApp = await setupTestApp();
         |                                       ^
      28 |     app = testApp.app;
      29 |     port = app.getHttpServer().address().port;
      30 |     

      at Object.<anonymous> (test/websocket.smoke.spec.ts:27:39)

  ● WebSocket Smoke Test › should handle multiple concurrent connections

    TypeError: (0 , websocket_test_setup_1.setupTestApp) is not a function

      25 |   beforeAll(async () => {
      26 |     // Setup test application
    > 27 |     const testApp = await setupTestApp();
         |                                       ^
      28 |     app = testApp.app;
      29 |     port = app.getHttpServer().address().port;
      30 |     

      at Object.<anonymous> (test/websocket.smoke.spec.ts:27:39)

FAIL test/rtc.integration.spec.ts
  ● RtcGateway › emitToUser › should emit event to all user sockets

    TypeError: gateway.getUserSockets is not a function

      141 |       
      142 |       // Add test socket
    > 143 |       gateway.getUserSockets().set(userId, new Set(['socket-1', 'socket-2']));
          |               ^
      144 |       
      145 |       // Call the method
      146 |       const result = gateway.emitToUser(userId, event, data);

      at Object.<anonymous> (test/rtc.integration.spec.ts:143:15)

  ● RtcGateway › emitToUser › should return false if user has no sockets

    TypeError: gateway.emitToUser is not a function

      153 |
      154 |     it('should return false if user has no sockets', () => {
    > 155 |       const result = gateway.emitToUser('non-existent-user', 'test-event', {});
          |                              ^
      156 |       expect(result).toBe(false);
      157 |       expect(gateway.testServer.to).not.toHaveBeenCalled();
      158 |     });

      at Object.<anonymous> (test/rtc.integration.spec.ts:155:30)

  ● RtcGateway › handleConnection › should handle successful connection

    TypeError: gateway.handleConnection is not a function

      161 |   describe('handleConnection', () => {
      162 |     it('should handle successful connection', async () => {
    > 163 |       await gateway.handleConnection(mockSocket);
          |                     ^
      164 |       
      165 |       // Verify socket was added to userSockets
      166 |       expect(gateway.getUserSockets().get('test-user-id')).toBeDefined();

      at Object.<anonymous> (test/rtc.integration.spec.ts:163:21)

  ● RtcGateway › handleConnection › should handle connection error

    TypeError: gateway.handleConnection is not a function

      176 |       };
      177 |       
    > 178 |       await gateway.handleConnection(errorSocket);
          |                     ^
      179 |       
      180 |       // Verify error was handled
      181 |       expect(errorSocket.disconnect).toHaveBeenCalled();

      at Object.<anonymous> (test/rtc.integration.spec.ts:178:21)

  ● RtcGateway › handleDisconnect › should handle disconnection

    TypeError: gateway.getUserSockets is not a function

      191 |       // Add test data
      192 |       const userSockets = new Set([socketId]);
    > 193 |       gateway.getUserSockets().set(userId, userSockets);
          |               ^
      194 |       gateway.getSocketToUser().set(socketId, userId);
      195 |       
      196 |       // Verify initial state

      at Object.<anonymous> (test/rtc.integration.spec.ts:193:15)

FAIL test/websocket.heartbeat.test.ts
  ● WebSocket Heartbeat › should connect to the WebSocket server

    TypeError: Cannot read properties of undefined (reading 'on')

      86 |     const socket = ioClient('http://localhost:3000');
      87 |     
    > 88 |     socket.on('connect', () => {
         |            ^
      89 |       expect(socket.connected).toBe(true);
      90 |       socket.disconnect();
      91 |       done();

      at Object.<anonymous> (test/websocket.heartbeat.test.ts:88:12)

  ● WebSocket Heartbeat › should handle ping-pong

    TypeError: Cannot read properties of undefined (reading 'emit')

       97 |     
       98 |     // Mock the pong response
    >  99 |     (socket.emit as jest.Mock).mockImplementation((event, data, callback) => {
          |             ^
      100 |       if (event === 'ping' && typeof callback === 'function') {
      101 |         callback({ timestamp: data.timestamp });
      102 |       }

      at Object.<anonymous> (test/websocket.heartbeat.test.ts:99:13)

  ● WebSocket Heartbeat › should handle disconnection

    TypeError: Cannot read properties of undefined (reading 'on')

      114 |     const socket = ioClient('http://localhost:3000');
      115 |     
    > 116 |     socket.on('disconnect', () => {
          |            ^
      117 |       expect(socket.connected).toBe(false);
      118 |       done();
      119 |     });

      at Object.<anonymous> (test/websocket.heartbeat.test.ts:116:12)

  ● WebSocket Heartbeat › should handle connection and disconnection on the gateway

    TypeError: Cannot read properties of undefined (reading 'on')

      128 |     const handleDisconnectSpy = jest.spyOn(gateway, 'handleDisconnect');
      129 |     
    > 130 |     socket.on('connect', () => {
          |            ^
      131 |       expect(handleConnectionSpy).toHaveBeenCalledTimes(1);
      132 |       expect(handleDisconnectSpy).not.toHaveBeenCalled();
      133 |       socket.disconnect();

      at Object.<anonymous> (test/websocket.heartbeat.test.ts:130:12)

FAIL test/websocket.connection.spec.ts
  ● Console

    console.log
      Test WebSocket server listening on ws://127.0.0.1:49276

      at Server.<anonymous> (test/websocket.connection.spec.ts:53:17)

  ● WebSocket Connection › should establish WebSocket connection

    TypeError: WebSocketModule.WebSocket is not a constructor

      26 | const createWebSocketClient = (url: string): Promise<WebSocket> => {
      27 |   return new Promise((resolve, reject) => {
    > 28 |     const ws = new WebSocketModule.WebSocket(url);
         |                ^
      29 |     
      30 |     ws.on('open', () => resolve(ws));
      31 |     ws.on('error', reject);

      at test/websocket.connection.spec.ts:28:16
      at createWebSocketClient (test/websocket.connection.spec.ts:27:10)
      at Object.<anonymous> (test/websocket.connection.spec.ts:121:22)

  ● WebSocket Connection › should send and receive messages

    TypeError: WebSocketModule.WebSocket is not a constructor

      139 |   it('should send and receive messages', (done) => {
      140 |     const testMessage = 'Hello, WebSocket!';
    > 141 |     const ws = new WebSocketModule.WebSocket(`ws://127.0.0.1:${port}`);
          |                ^
      142 |     
      143 |     // Set up a test timeout
      144 |     const testTimeout = setTimeout(() => {

      at Object.<anonymous> (test/websocket.connection.spec.ts:141:16)

  ● WebSocket Connection › should handle connection close

    TypeError: WebSocketModule.WebSocket is not a constructor

      26 | const createWebSocketClient = (url: string): Promise<WebSocket> => {
      27 |   return new Promise((resolve, reject) => {
    > 28 |     const ws = new WebSocketModule.WebSocket(url);
         |                ^
      29 |     
      30 |     ws.on('open', () => resolve(ws));
      31 |     ws.on('error', reject);

      at test/websocket.connection.spec.ts:28:16
      at createWebSocketClient (test/websocket.connection.spec.ts:27:10)
      at Object.<anonymous> (test/websocket.connection.spec.ts:198:22)

/Users/louisciccone/Desktop/Rythm_Daw/server/src/modules/chat/chat.gateway.ts:68
            client.on('pong', (data) => {
                   ^

TypeError: client.on is not a function
    at ChatGateway.handleConnection (/Users/louisciccone/Desktop/Rythm_Daw/server/src/modules/chat/chat.gateway.ts:68:20)
    at Object.<anonymous> (/Users/louisciccone/Desktop/Rythm_Daw/server/test/ws-heartbeat.test.ts:88:13)
    at Promise.then.completed (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at _runTest (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/Users/louisciccone/Desktop/Rythm_Daw/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)

Node.js v24.2.0
 ELIFECYCLE  Test failed. See above for more details.
