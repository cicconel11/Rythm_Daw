name: CI ECR

on:
  push:
    branches:
      - main
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write    # needed for OIDC to AWS
      contents: read
    steps:
      - name: ⬇️  Checkout source
        uses: actions/checkout@v4

      # ---------- NEW: Docker Buildx + QEMU ----------
      - name: 🛠️  Set up QEMU (multi-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: 🏗️  Set up Docker Buildx builder
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug  # easier to debug if build fails

      # ---------- pnpm install ----------
      - name: 📦  Set up Node & pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile

      # ---------- AWS ECR login ----------
      - name: 🔐  Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ---------- Build & push ----------
      - name: 🐳  Build & push image to ECR
        run: |
          IMAGE="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:latest \
            . 